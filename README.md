# Backup MikroTik from NetBox

Скрипт для автоматического создания бэкапов конфигураций MikroTik роутеров из NetBox с загрузкой в GCP bucket и Git репозиторий.

## Требования

- Python 3.7+
- Доступ к NetBox API
- SSH ключ для подключения к MikroTik роутерам
- GCP service account key с правами на bucket
- Git репозиторий инициализирован в папке проекта

## Установка

```bash
pip install -r requirements.txt
```

## Настройка

Перед запуском необходимо заменить следующие переменные в `routers-backup.py`:

### GCP настройки
- `bucket_name` - имя GCP bucket для хранения бэкапов
- `bucket_key` - путь к JSON ключу GCP service account с правами на bucket

### NetBox настройки
- `NETBOX_URL` - URL NetBox сервера (например: `http://netbox.example.com`)
- `TOKEN` - токен для доступа к NetBox API
- `tag_for_backup` - тег для фильтрации устройств (по умолчанию: `mikrotik`)

### SSH настройки
- `user_for_backup` - пользователь для SSH подключения к MikroTik
- `path_to_private_key` - путь к SSH приватному ключу для подключения к MikroTik
- `port_ssh` - порт SSH подключения (по умолчанию: 333)

### Локальные настройки
- `folder_project` - путь к папке с проектом (должна быть Git репозиторием)

### Дополнительные параметры
- `DELAY_AFTER_SCP` - задержка после SCP операции в секундах (по умолчанию: 5)
- `DELAY_BETWEEN_ROUTERS` - задержка между обработкой роутеров в секундах (по умолчанию: 5)

## Принцип работы

1. **Валидация конфигурации**
   - Проверка существования GCP ключа, SSH ключа и директории проекта
   - Автоматическое создание директории проекта при отсутствии

2. **Получение списка устройств из NetBox**
   - Считываются данные по MikroTik из VM's и Devices с указанным тегом (`tag_for_backup`)
   - Обязательно наличие primary IP у каждого устройства
   - Дубликаты имен обрабатываются с предупреждением (последний перезаписывает предыдущий)

3. **Создание бэкапов на MikroTik**
   - Подключение по SSH через scrapli (синхронный режим)
   - Создание локальных файлов на роутере:
     - `export.rsc` - экспорт конфигурации
     - `config.backup` - бинарный бэкап
   - Если файлы уже существуют, они перезаписываются

4. **Скачивание файлов на локальный сервер**
   - Скачивание через SCP в директории по имени маршрутизатора
   - Структура локальных директорий: `{folder_project}/{router_name}/`
   - На локальном сервере всегда хранятся последние актуальные файлы
   - Задержка после SCP операции для стабилизации

5. **Валидация скачанных файлов**
   - Проверка существования файлов
   - Проверка минимального размера файлов (100 байт по умолчанию)

6. **Загрузка в GCP bucket**
   - Файлы копируются в GCP bucket только после успешной валидации
   - Структура: `{router_name}/{YYYY-MM-DD}/{router_name}-{filename}`
   - Создаются директории под каждый маршрутизатор и даты

7. **Коммит в Git**
   - В Git пушатся только файлы `export.rsc` с историей изменений
   - Файлы `*.backup` исключены через `.gitignore`
   - Формат коммита: `{YYYY-MM-DD} commit from script`
   - Коммит и push выполняются только при наличии изменений

## Структура проекта

После выполнения скрипта структура директорий будет следующей:

```
{folder_project}/
├── router1/
│   ├── export.rsc          # текстовый экспорт конфигурации
│   └── config.backup        # бинарный бэкап (исключен из Git)
├── router2/
│   ├── export.rsc
│   └── config.backup
└── ...
```

В GCP bucket файлы хранятся в структуре:
```
bucket_name/
├── router1/
│   └── 2024-01-15/
│       ├── router1-export.rsc
│       └── router1-config.backup
├── router2/
│   └── 2024-01-15/
│       ├── router2-export.rsc
│       └── router2-config.backup
└── ...
```

## Запуск

```bash
python routers-backup.py
```

Скрипт выводит информацию о процессе в консоль с уровнем логирования INFO:
- Успешные операции
- Предупреждения (отсутствие primary IP, дубликаты имен)
- Ошибки подключения и обработки

## Логирование

Скрипт использует стандартный модуль `logging` с форматом:
```
YYYY-MM-DD HH:MM:SS - LEVEL - MESSAGE
```

Уровни логирования:
- `INFO` - успешные операции и общая информация
- `WARNING` - предупреждения (пропущенные устройства, малые файлы)
- `ERROR` - ошибки подключения, валидации, загрузки

## Обработка ошибок

- При ошибке валидации конфигурации скрипт завершается с кодом 1
- При ошибке подключения к NetBox скрипт завершается с кодом 1
- При ошибке подключения к GCP bucket скрипт завершается с кодом 1
- При ошибке обработки отдельного роутера скрипт продолжает работу с остальными
- В конце выводится статистика: количество успешных и неудачных бэкапов
- Git push выполняется даже при наличии ошибок (если есть изменения)

## Troubleshooting

### Ошибка подключения к NetBox
- Проверьте правильность `NETBOX_URL` и `TOKEN`
- Убедитесь, что NetBox доступен с сервера запуска скрипта

### Ошибка SSH подключения к MikroTik
- Проверьте правильность пути к SSH ключу (`path_to_private_key`)
- Убедитесь, что ключ имеет правильные права доступа (chmod 600)
- Проверьте доступность роутера по сети и правильность порта

### Ошибка загрузки в GCP
- Проверьте правильность пути к service account key (`bucket_key`)
- Убедитесь, что service account имеет права на запись в bucket
- Проверьте существование bucket и его доступность

### Ошибка Git push
- Убедитесь, что директория проекта является Git репозиторием
- Проверьте настройку remote origin
- Убедитесь, что есть права на push в удаленный репозиторий

### Файлы слишком маленькие
- Скрипт валидирует минимальный размер файлов (100 байт)
- Если файл меньше, он не загружается в GCP
- Проверьте, что на роутере достаточно места для создания бэкапов
