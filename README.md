# Backup MikroTik from NetBox

Скрипт для автоматического создания бэкапов конфигураций MikroTik роутеров из NetBox с загрузкой в GCP bucket и Git репозиторий.

## Установка

```bash
pip install -r requirements.txt
```

## Настройка

Перед запуском необходимо заменить следующие переменные в `routers-backup.py`:

- `bucket_name` - имя GCP bucket для хранения бэкапов
- `bucket_key` - путь к JSON ключу GCP с правами на bucket
- `folder_project` - путь к папке с проектом
- `NETBOX_URL` - URL NetBox сервера
- `TOKEN` - токен для доступа к NetBox API
- `user_for_backup` - пользователь для SSH подключения к MikroTik
- `path_to_private_key` - путь к SSH приватному ключу для подключения к MikroTik
- `port_ssh` - порт SSH подключения (по умолчанию 333)

## Принцип работы

1. **Получение списка устройств из NetBox**
   - Считываются данные по MikroTik из VM's и Devices с тегом `mikrotik`
   - Обязательно наличие primary IP у каждого устройства

2. **Создание бэкапов на MikroTik**
   - Подключение по SSH через scrapli (синхронный режим)
   - Создание локальных файлов на роутере:
     - `export.rsc` - экспорт конфигурации
     - `config.backup` - бинарный бэкап
   - Если файлы уже существуют, они перезаписываются

3. **Скачивание файлов на локальный сервер**
   - Скачивание через SCP в директории по имени маршрутизатора
   - На локальном сервере всегда хранятся последние актуальные файлы

4. **Загрузка в GCP bucket**
   - Файлы копируются в GCP bucket
   - Структура: `{router_name}/{date}/{router_name}-{filename}`
   - Создаются директории под каждый маршрутизатор и даты

5. **Коммит в Git**
   - В Git пушатся только файлы `export.rsc` с историей изменений
   - Файлы `*.backup` исключены через `.gitignore`

## Запуск

```bash
python routers-backup.py
```

## Требования

- Доступ к NetBox API
- SSH ключ для подключения к MikroTik роутерам
- GCP service account key с правами на bucket
- Git репозиторий инициализирован в папке проекта
